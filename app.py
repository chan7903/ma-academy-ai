import streamlit as st
from PIL import Image
import google.generativeai as genai
import pandas as pd
import io

# ----------------------------------------------------------
# [ì„¤ì • 1] API í‚¤ ì…ë ¥ (ì—¬ê¸°ì— ì›ì¥ë‹˜ì˜ í‚¤ë¥¼ ë„£ì–´ì£¼ì„¸ìš”)
# ----------------------------------------------------------
GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
genai.configure(api_key=GOOGLE_API_KEY)

# ----------------------------------------------------------
# [ì„¤ì • 2] í˜ì´ì§€ ê¸°ë³¸ ë””ìì¸ ë° íƒ€ì´í‹€
# ----------------------------------------------------------
st.set_page_config(page_title="MAí•™ì› AI ì˜¤ë‹µ ë„ìš°ë¯¸", page_icon="ğŸ«")

# ë¡œê³  ë° í—¤ë” ë””ìì¸
st.markdown("""
    <div style='text-align: left;'>
        <h1 style='margin-bottom: 0;'>ğŸ« MAí•™ì›</h1>
        <h3 style='margin-top: 0; color: gray;'>AI ì˜¤ë‹µ ë„ìš°ë¯¸</h3>
    </div>
    <hr>
    """, unsafe_allow_html=True)

# ----------------------------------------------------------
# [ì„¤ì • 3] ì‚¬ì´ë“œë°”: í•™ë…„, ê³¼ëª©, ë§íˆ¬ ì„¤ì •
# ----------------------------------------------------------
with st.sidebar:
    st.header("í•™ìƒ ì„¤ì •")
    
    # 2022 ê°œì • êµìœ¡ê³¼ì • ë°˜ì˜í•œ ê³¼ëª© ë¦¬ìŠ¤íŠ¸
    subject_options = [
        "ì´ˆ4", "ì´ˆ5", "ì´ˆ6",
        "ì¤‘1", "ì¤‘2", "ì¤‘3",
        "ê³µí†µìˆ˜í•™1", "ê³µí†µìˆ˜í•™2", "ëŒ€ìˆ˜", "ë¯¸ì ë¶„1", # ê³ 1~ (2022 ê°œì •)
        "ìˆ˜1", "ìˆ˜2", "ë¯¸ì ë¶„", "í™•í†µ" # ê¸°ì¡´ ê³ ë“± ê³¼ì •
    ]
    
    student_grade = st.selectbox("í•™ë…„ ë° ê³¼ëª© ì„ íƒ", subject_options)
    
    # í•™ë…„ë³„ ë§íˆ¬(Persona) ë¡œì§
    # ì´ˆ4 ~ ì¤‘2: ì¹œì ˆí•¨ / ì¤‘3 ~ ê³ ë“±: ì—„ê²©í•¨
    young_grades = ["ì´ˆ4", "ì´ˆ5", "ì´ˆ6", "ì¤‘1", "ì¤‘2"]
    
    if student_grade in young_grades:
        st.info("ğŸ’¡ ëª¨ë“œ: ì¹œì ˆí•œ ê²©ë ¤ ëª¨ë“œ")
        tone_instruction = """
        - ëŒ€ìƒ: ì´ˆë“±~ì¤‘2 í•™ìƒ.
        - ë§íˆ¬: ì¹œì ˆí•˜ê³  ë‹¤ì •í•˜ê²Œ, ì¹­ì°¬ê³¼ ê²©ë ¤ë¥¼ ë§ì´ í•´ì£¼ì„¸ìš”. (ì˜ˆ: "ì •ë§ ì•„ê¹Œì› ì–´!", "ë‹¤ìŒì— ê¼­ ë§ì¶œ ìˆ˜ ìˆì–´!")
        - ì„¤ëª… ë°©ì‹: ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ìœ ë¥¼ ì‚¬ìš©í•˜ê³ , ë‹¨ê³„ë³„ë¡œ ì°¨ê·¼ì°¨ê·¼ ì„¤ëª…í•˜ì„¸ìš”.
        - ì´ëª¨ì§€: ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ë¶„ìœ„ê¸°ë¥¼ ë°ê²Œ í•˜ì„¸ìš”.
        """
        is_strict = False
    else:
        st.info("ğŸ’¡ ëª¨ë“œ: ì—„ê²©í•œ ì…ì‹œ ëª¨ë“œ")
        tone_instruction = """
        - ëŒ€ìƒ: ì¤‘3 ë° ê³ ë“±í•™ìƒ (ì…ì‹œ ì¤€ë¹„).
        - ë§íˆ¬: ì—„ê²©í•˜ê³  ê±´ì¡°í•˜ê²Œ. ê°ì •ì ì¸ ìœ„ë¡œë³´ë‹¤ëŠ” íŒ©íŠ¸ì™€ ë…¼ë¦¬ ìœ„ì£¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”. (ì˜ˆ: "ì´ ê°œë… ë¶€ì¬ê°€ ì˜¤ë‹µ ì›ì¸ì„.", "í’€ì´ ê³¼ì •ì„ ë‹¤ì‹œ ì ê²€í•  ê²ƒ.")
        - ì„¤ëª… ë°©ì‹: ê°„ê²°í•˜ê³  í•µì‹¬ë§Œ ì§šìœ¼ì„¸ìš”. ìœ ì¹˜í•œ ê²©ë ¤ëŠ” ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”.
        - ì´ëª¨ì§€: ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
        """
        is_strict = True

# ----------------------------------------------------------
# [ê¸°ëŠ¥ 1] ì´ë¯¸ì§€ ì…ë ¥ (ì¹´ë©”ë¼ & ê°¤ëŸ¬ë¦¬)
# ----------------------------------------------------------
st.markdown("##### 1. ë¬¸ì œ ì—…ë¡œë“œ")
tab1, tab2 = st.tabs(["ğŸ“¸ ì¹´ë©”ë¼ ì´¬ì˜", "ğŸ“‚ ê°¤ëŸ¬ë¦¬ ì—…ë¡œë“œ"])

img_file = None

with tab1:
    camera_img = st.camera_input("ë¬¸ì œ ì´¬ì˜") 
    if camera_img:
        img_file = camera_img

with tab2:
    uploaded_img = st.file_uploader("ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ", type=['jpg', 'png', 'jpeg'])
    if uploaded_img:
        img_file = uploaded_img

# ----------------------------------------------------------
# [ê¸°ëŠ¥ 2] AI ë¶„ì„ ë° ë¬¸ì œ í’€ì´
# ----------------------------------------------------------
if img_file:
    image = Image.open(img_file)
    st.image(image, caption="ì„ íƒëœ ë¬¸ì œ", use_container_width=True)

    if st.button("AI ë¶„ì„ ì‹œì‘"):
        with st.spinner("MAí•™ì› AI ì„ ìƒë‹˜ì´ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
            try:
                # Gemini 2.5 Flash ëª¨ë¸ í˜¸ì¶œ (ìµœì‹  ëª¨ë¸ëª… ì‚¬ìš©)
                model = genai.GenerativeModel('gemini-1.5-flash') 
                
                # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                prompt = f"""
                ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ìˆ˜í•™ ì „ë¬¸ ê°•ì‚¬ì…ë‹ˆë‹¤. 
                í˜„ì¬ í•™ìƒì˜ í•™ë…„/ê³¼ëª©ì€ **{student_grade}**ì…ë‹ˆë‹¤.
                
                [ì§€ì‹œì‚¬í•­]
                1. ì´ë¯¸ì§€ ì† ë¬¸ì œë¥¼ í…ìŠ¤íŠ¸(LaTeX í¬í•¨)ë¡œ ì •í™•íˆ ë³€í™˜í•˜ì„¸ìš”.
                2. ì´ ë¬¸ì œì˜ **'ë‹¨ì›ëª…'**ì„ ë°˜ë“œì‹œ ì²« ì¤„ì— ëª…ì‹œí•˜ì„¸ìš”. (í˜•ì‹: [ë‹¨ì›: ë‹¨ì›ëª…])
                3. í•™ìƒì˜ ëˆˆë†’ì´ì— ë§ì¶° ìƒì„¸í•œ í’€ì´ë¥¼ ì œê³µí•˜ì„¸ìš”.
                4. **ë§íˆ¬ ì§€ì¹¨**: {tone_instruction}
                5. í’€ì´ ë§ˆì§€ë§‰ì— ì´ ë¬¸ì œì™€ ìˆ«ìë§Œ ë°”ê¾¼ **'ìŒë‘¥ì´ ë¬¸ì œ'** 1ê°œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
                """
                
                response = model.generate_content([prompt, image])
                
                # ê²°ê³¼ ì €ì¥ (ì„¸ì…˜ ìƒíƒœ í™œìš©)
                st.session_state['analysis_result'] = response.text
                st.session_state['has_result'] = True
                
            except Exception as e:
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# ----------------------------------------------------------
# [ê¸°ëŠ¥ 3] ê²°ê³¼ ì¶œë ¥ ë° ì¶”ê°€ ê¸°ëŠ¥
# ----------------------------------------------------------
if 'has_result' in st.session_state and st.session_state['has_result']:
    st.markdown("### ğŸ“ ë¶„ì„ ê²°ê³¼")
    st.write(st.session_state['analysis_result'])
    
    st.markdown("---")
    
    # ìŒë‘¥ì´ ë¬¸ì œ ì¶”ê°€ ìƒì„± ë²„íŠ¼
    if st.button("ğŸ”„ ìŒë‘¥ì´ ë¬¸ì œ ë” ë§Œë“¤ê¸°"):
         with st.spinner("ë¹„ìŠ·í•œ ë¬¸ì œë¥¼ ì¶”ê°€ë¡œ ìƒì„± ì¤‘..."):
            try:
                # ë¬¸ë§¥ ìœ ì§€ë¥¼ ìœ„í•´ ì´ì „ ê²°ê³¼ë¥¼ í¬í•¨í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì—¬ê¸°ì„  ê°„ë‹¨íˆ ì¬ìš”ì²­
                model = genai.GenerativeModel('gemini-1.5-flash')
                extra_prompt = f"""
                ë°©ê¸ˆ í‘¼ ë¬¸ì œì™€ ë™ì¼í•œ ìœ í˜•ì˜ **ìŒë‘¥ì´ ë¬¸ì œ 2ê°œ**ë¥¼ ë” ë§Œë“¤ì–´ì¤˜.
                í•™ìƒ í•™ë…„: {student_grade}
                ë§íˆ¬: {tone_instruction}
                ì •ë‹µê³¼ í•´ì„¤ì€ ë§¨ ì•„ë˜ì— ë”°ë¡œ ì ì–´ì¤˜.
                """
                # ì´ë¯¸ì§€ ì—†ì´ í…ìŠ¤íŠ¸ë¡œë§Œ ìš”ì²­ (ì´ë¯¸ ìœ„ì—ì„œ ë¶„ì„í–ˆìœ¼ë¯€ë¡œ ë‚´ìš©ì„ ì•ˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ë³´ëƒ„)
                # ì—¬ê¸°ì„œëŠ” ì •í™•ë„ë¥¼ ìœ„í•´ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ë³´ëƒ…ë‹ˆë‹¤.
                response_extra = model.generate_content([extra_prompt, image])
                st.markdown("#### â• ì¶”ê°€ ìŒë‘¥ì´ ë¬¸ì œ")
                st.write(response_extra.text)
            except Exception as e:
                st.error(f"ì¶”ê°€ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")

# ----------------------------------------------------------
# [ê¸°ëŠ¥ 4] ì˜¤ë‹µë…¸íŠ¸ & í†µê³„ (ì˜ˆì‹œ ë°ì´í„°)
# ----------------------------------------------------------
st.markdown("---")
st.header("ğŸ“Š ë‚´ ì˜¤ë‹µë…¸íŠ¸ ê´€ë¦¬")

# (ë‚˜ì¤‘ì—ëŠ” ì—¬ê¸°ê°€ Notion ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°ë  ë¶€ë¶„ì…ë‹ˆë‹¤)
# ì§€ê¸ˆì€ í™”ë©´ êµ¬ì„±ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ê°€ì§œ ë°ì´í„°ì…ë‹ˆë‹¤.
data = {
    'ë‹¨ì›': ['ì´ì°¨ë°©ì •ì‹', 'ì´ì°¨ë°©ì •ì‹', 'ì‚¼ê°í•¨ìˆ˜', 'ìˆ˜ì—´', 'ë‹¤í•­ì‹', 'ì´ì°¨ë°©ì •ì‹'],
    'ë‚ ì§œ': ['5/1', '5/2', '5/3', '5/5', '5/6', '5/7'],
    'ê²°ê³¼': ['ì˜¤ë‹µ', 'ì˜¤ë‹µ', 'ì •ë‹µ', 'ì˜¤ë‹µ', 'ì •ë‹µ', 'ì˜¤ë‹µ']
}
df = pd.DataFrame(data)

stat_tab1, stat_tab2 = st.tabs(["ğŸ“‰ ì·¨ì•½ ë‹¨ì› ë¶„ì„", "ğŸ“œ ì „ì²´ ë¦¬ìŠ¤íŠ¸"])

with stat_tab1:
    # 'ì˜¤ë‹µ'ì¸ ê²ƒë§Œ ê³¨ë¼ì„œ ë‹¨ì›ë³„ë¡œ ì…ˆ
    wrong_df = df[df['ê²°ê³¼'] == 'ì˜¤ë‹µ']
    if not wrong_df.empty:
        counts = wrong_df['ë‹¨ì›'].value_counts()
        st.bar_chart(counts)
        st.caption("ìœ„ ê·¸ë˜í”„ê°€ ë†’ì€ ë‹¨ì›ì´ ì·¨ì•½í•œ ë‹¨ì›ì…ë‹ˆë‹¤.")
    else:
        st.write("ì˜¤ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

with stat_tab2:
    st.dataframe(df, use_container_width=True)